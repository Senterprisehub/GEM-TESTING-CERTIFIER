<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEM TESTING (IDENTIFICATION) LABORATORY â€” S R Nexus</title>
    <!-- Use Inter font for a modern, clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Great+Vibes&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <!-- Load required libraries for PDF generation and screenshot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" defer></script>
    <style>
        :root {
            --bgA: #0f172a;
            --bgB: #0f4c81;
            --panel: #ffffff;
            --muted: #6b7280;
            --accent: #3b82f6;
            --gold: #c9a227;
            --radius: 14px;
            --glass: rgba(255, 255, 255, 0.06);
            --forest-green: #228B22;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
            color: var(--bgA);
            background: linear-gradient(180deg, #eef2ff, #f8fafc);
        }

        .wrap {
            max-width: 1100px;
            margin: 18px auto;
            padding: 18px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 16px;
            border-radius: 12px;
            background: linear-gradient(90deg, var(--bgB), #1e3a8a);
            color: #fff;
            box-shadow: 0 10px 30px rgba(16, 24, 40, 0.08);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo {
            width: 64px;
            height: 64px;
            border-radius: 14px;
            background: linear-gradient(135deg, #60a5fa, #1e40af);
            display: grid;
            place-items: center;
            color: #fff;
            font-weight: 800;
            font-size: 20px;
        }

        h1 {
            margin: 0;
            font-size: 18px;
        }

        .sub {
            font-size: 13px;
            opacity: 0.9;
        }

        main {
            margin-top: 18px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
        }

        .card {
            background: var(--panel);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: 0 16px 40px rgba(16, 24, 40, 0.06);
            border: 1px solid rgba(16, 24, 40, 0.04);
        }

        .section-title {
            font-weight: 600;
            color: var(--bgB);
            margin: 0 0 8px 0;
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
        }

        .upload-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .file-btn {
            background: linear-gradient(180deg, var(--accent), #1e40af);
            color: #fff;
            padding: 10px 14px;
            border-radius: 12px;
            border: 0;
            cursor: pointer;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .file-btn:hover {
            transform: translateY(-2px);
        }

        .file-btn input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(16, 24, 40, 0.06);
            padding: 10px 12px;
            border-radius: 12px;
            color: var(--bgB);
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-ghost:hover {
            background: #f1f5f9;
        }

        .btn-accent {
            background: linear-gradient(180deg, var(--accent), #1e40af);
            color: #fff;
            padding: 10px 12px;
            border-radius: 12px;
            border: 0;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-accent:hover {
            transform: translateY(-2px);
        }

        .small {
            font-size: 13px;
        }

        .grid2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .metric {
            background: linear-gradient(180deg, #fff, #f8fbff);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(16, 24, 40, 0.04);
        }

        .k {
            color: var(--muted);
            font-size: 13px;
        }

        .v {
            font-weight: 700;
        }

        .cert {
            position: relative;
            background: linear-gradient(180deg, #fff, #fcfdff);
            border-radius: 14px;
            padding: 18px;
            border: 1px solid rgba(16, 24, 40, 0.06);
            overflow: hidden;
            margin-bottom: 24px;
        }
        
        .cert .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-12deg);
            font-family: Georgia, serif;
            font-weight: 800;
            font-size: 120px;
            line-height: 1.2;
            text-align: center;
            color: rgba(16, 24, 40, 0.04);
            pointer-events: none;
            width: 100%;
            white-space: nowrap;
        }

        .cert-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid rgba(16, 24, 40, 0.04);
            padding-bottom: 10px;
        }

        .cert-title {
            font-weight: 700;
            font-size: 32px;
            color: var(--bgB);
        }
        
        .cert-meta {
            font-size: 13px;
            color: var(--muted);
            text-align: right;
        }

        .cert-body {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .thumb {
            flex-basis: 34%;
            min-width: 180px;
            background: #f8fafc;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid rgba(16, 24, 40, 0.03);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cert-table {
            flex: 1;
            min-width: 240px;
        }

        .ct-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(16, 24, 40, 0.03);
            flex-wrap: wrap;
        }
        
        .ct-row .key {
            color: var(--muted);
            width: 38%;
        }
        
        .ct-row .val {
            font-weight: 700;
            flex: 1;
        }
        
        .inline, .inline-input {
            border: 0;
            background: transparent;
            border-bottom: 1px dashed rgba(16, 24, 40, 0.06);
            padding: 2px 5px;
            font-weight: 700;
            width: 100%;
            text-align: right;
            outline: none;
        }
        
        .inline-span {
            border: 0;
            background: transparent;
            border-bottom: 1px dashed rgba(16, 24, 40, 0.06);
            padding: 2px 5px;
            font-weight: 700;
            text-align: right;
            outline: none;
            display: inline-block;
            min-width: 100px;
        }

        .inline-div {
            font-weight: 700;
            padding: 2px 5px;
            word-wrap: break-word; 
            overflow-wrap: break-word;
            text-align: right;
        }

        #imagePreviewSection {
            display: none;
            text-align: center;
            padding: 16px;
        }
        
        #uploadedImagePreview {
            max-width: 70%;
            height: auto;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin: 12px auto;
        }

        .sig-row {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .sig-box {
            flex: 1;
            text-align: center;
            border-top: 1px solid rgba(16, 24, 40, 0.06);
            padding-top: 8px;
            color: var(--muted);
        }

        .cert canvas {
            max-width: 100%;
            border-radius: 8px;
        }

        .controls-bottom {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 12px;
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: var(--bgA);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            background: #10b981;
        }

        .toast-error {
            background: #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .btn-loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 900px) {
            .thumb {
                flex-basis: 100%;
            }
        }

        .api-key-section {
            margin-top: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .api-key-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            margin-top: 6px;
            font-family: monospace;
        }
        
        .api-key-help {
            font-size: 12px;
            color: #64748b;
            margin-top: 6px;
        }

        .stone-entry {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed rgba(16, 24, 40, 0.08);
        }
        
        .stone-heading {
            font-weight: 700;
            color: var(--bgB);
            margin-bottom: 8px;
        }
        
        footer {
            margin-top: 36px;
            text-align: center;
            font-size: 12px;
            color: var(--muted);
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <div class="brand">
                <div class="logo">SR</div>
                <div>
                    <h1>GEM TESTING (IDENTIFICATION)</h1>
                    <div class="sub">S R Nexus â€” Modern Lab Interface</div>
                </div>
            </div>
            <div class="muted">Simplified Workflow â€¢ Direct Analysis â€¢ Editable Certificate</div>
        </header>

        <main>
            <!-- 0) API Key Section - Added for local testing -->
            <section class="card" id="apiKeySection">
                <h3 class="section-title">Gemini API Key</h3>
                <div class="muted">Required for gemstone analysis functionality</div>
                <div class="api-key-section">
                    <label for="apiKeyInput">Enter your Gemini API Key:</label>
                    <input type="password" id="apiKeyInput" class="api-key-input" placeholder="AIza...">
                    <div class="api-key-help">
                        Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>. 
                        Your key is stored only in your browser.
                    </div>
                </div>
            </section>

            <!-- 1) Upload and Controls -->
            <section class="card">
                <h3 class="section-title">1) Upload Image</h3>
                <div class="upload-row">
                    <label class="file-btn">
                        Choose Photo
                        <input id="fileInput" type="file" accept="image/*">
                    </label>
                    <button id="generateCertBtn" class="btn-accent" disabled>Generate Certificate</button>
                    <button id="resetBtn" class="btn-ghost" disabled>Reset</button>
                </div>
                <p class="muted" style="margin-top:12px; margin-bottom:0;">Upload a clear image of the gemstone. The entire image will be used for analysis.</p>
            </section>

            <!-- 2) Image Preview - This is the new section for immediate feedback -->
            <section class="card" id="imagePreviewSection">
                <h3 class="section-title">2) Image Preview</h3>
                <div class="muted">This is the image you selected for analysis.</div>
                <img id="uploadedImagePreview" src="" alt="Image preview of uploaded gemstone">
            </section>

            <!-- 3) Analysis Results -->
            <section class="card">
                <h3 class="section-title">3) Analysis Results</h3>
                <div class="muted">Analysis runs on the full uploaded image. You can edit any field in the certificate preview below before downloading.</div>
                <div id="metrics" class="grid2" style="margin-top:12px"></div>
            </section>

            <!-- 4) Certificate -->
            <section class="card">
                <h3 class="section-title">4) Certificate Preview</h3>
                <div class="controls-bottom">
                    <button id="downloadBtn" class="btn-accent" disabled>Download PDF</button>
                    <button id="downloadImageBtn" class="btn-ghost" disabled>Download Image</button>
                </div>
                <div id="certContainer" style="margin-top: 16px;">
                    <!-- Dynamically generated certificates will be added here -->
                </div>
            </section>
        </main>
        
        <footer>
            Â© 2020 GEM TESTING (IDENTIFICATION) LABORATORY. All rights reserved.<br>
            Certificate verification system | An ISO 9001:2015 Certified Company
        </footer>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // --- Element and State Management ---
        const fileInput = document.getElementById('fileInput');
        const uploadedImagePreview = document.getElementById('uploadedImagePreview');
        const imagePreviewSection = document.getElementById('imagePreviewSection');
        const resetBtn = document.getElementById('resetBtn');
        const generateCertBtn = document.getElementById('generateCertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadImageBtn = document.getElementById('downloadImageBtn');
        const metricsEl = document.getElementById('metrics');
        const toastContainer = document.getElementById('toastContainer');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiKeySection = document.getElementById('apiKeySection');
        const certContainer = document.getElementById('certContainer');

        // State to hold the original image data and last analysis results
        let originalImage = null;
        let base64Image = null;
        let previewURL = null;
        let lastAnalysisData = [];
        
        // Load API key from localStorage if available
        const savedApiKey = localStorage.getItem('gemini_api_key');
        if (savedApiKey) {
            apiKeyInput.value = savedApiKey;
        }

        // Save API key when changed
        apiKeyInput.addEventListener('change', () => {
            localStorage.setItem('gemini_api_key', apiKeyInput.value);
            showToast('API key saved', 'success');
        });

        // --- Toast notification system ---
        function showToast(message, type = 'default', duration = 4000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type !== 'default' ? 'toast-' + type : ''}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    if (toastContainer.contains(toast)) {
                       toastContainer.removeChild(toast);
                    }
                }, 500);
            }, duration);
        }
        
        // --- Helper function to convert image to base64 ---
        function getBase64Image(img) {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const dataURL = canvas.toDataURL('image/jpeg', 0.8);
            return dataURL.replace(/^data:image\/(png|jpeg);base64,/, "");
        }
        
        // Function to clean up the temporary URL to avoid memory leaks
        function cleanupPreviewURL() {
            if (previewURL) {
                URL.revokeObjectURL(previewURL);
                previewURL = null;
            }
        }

        // --- Core Application Workflow ---
        // New logic to handle image preview using URL.createObjectURL
        fileInput.addEventListener('change', async (e) => {
            cleanupPreviewURL();
            const file = e.target.files && e.target.files[0];
            if (!file) {
                return;
            }

            try {
                showToast('Processing image...', 'default', 3000);
                
                previewURL = URL.createObjectURL(file);
                uploadedImagePreview.src = previewURL;
                imagePreviewSection.style.display = 'block';

                const reader = new FileReader();
                const dataUrl = await new Promise((resolve, reject) => {
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = () => {
                        originalImage = img;
                        base64Image = getBase64Image(originalImage);
                        enableControls(true);
                        resolve();
                    };
                    img.onerror = reject;
                    img.src = dataUrl;
                });

                showToast('Image uploaded! Click "Generate Certificate" to begin analysis.', 'success');
            } catch (error) {
                console.error('Error during file upload and preview:', error);
                showToast('Error loading image. Please try again.', 'error');
                cleanupPreviewURL();
                enableControls(false);
                uploadedImagePreview.src = '';
                imagePreviewSection.style.display = 'none';
            }
        });
        
        // 2. Button to trigger certificate generation and rendering
        generateCertBtn.addEventListener('click', async () => {
            if (!originalImage || !base64Image) {
                showToast('Please upload an image first.', 'error');
                return;
            }

            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showToast('Please enter a valid Gemini API key', 'error');
                apiKeySection.scrollIntoView({ behavior: 'smooth' });
                return;
            }

            generateCertBtn.textContent = 'Analyzing...';
            generateCertBtn.disabled = true;
            generateCertBtn.classList.add('btn-loading');

            await analyzeAndFillFields(base64Image, originalImage, apiKey);
            
            generateCertBtn.textContent = 'Generate Certificate';
            generateCertBtn.disabled = false;
            generateCertBtn.classList.remove('btn-loading');
        });

        // 3. Reset the application to its initial state
        resetBtn.addEventListener('click', () => {
            let userConfirmed = false;
            try {
                // Using a try-catch for the confirm dialog
                userConfirmed = confirm('Are you sure you want to reset? All current data will be lost.');
            } catch (e) {
                userConfirmed = true; // Assume confirmation if the dialog doesn't work
            }

            if (userConfirmed) {
                cleanupPreviewURL();
                originalImage = null;
                base64Image = null;
                lastAnalysisData = [];
                fileInput.value = '';
                uploadedImagePreview.src = '';
                imagePreviewSection.style.display = 'none';
                metricsEl.innerHTML = '';
                certContainer.innerHTML = '';
                enableControls(false);

                showToast('Application reset successfully', 'success');
            }
        });

        // --- Helper functions for controls and rendering ---
        function enableControls(flag) {
            resetBtn.disabled = !flag;
            generateCertBtn.disabled = !flag;
            downloadBtn.disabled = !flag;
            downloadImageBtn.disabled = !flag;
        }

        // Draws the image onto the certificate canvas for the final document
        function renderCertificateImage(canvas, img) {
            const certCtx = canvas.getContext('2d');
            certCtx.clearRect(0, 0, canvas.width, canvas.height);
            if (!img) return;

            const cw = img.naturalWidth;
            const ch = img.naturalHeight;
            const scale = Math.min((canvas.width - 20) / cw, (canvas.height - 20) / ch);
            const w = cw * scale;
            const h = ch * scale;
            const x = (canvas.width - w) / 2;
            const y = (canvas.height - h) / 2;
            
            certCtx.fillStyle = '#ffffff';
            certCtx.fillRect(0, 0, canvas.width, canvas.height);
            
            certCtx.shadowColor = 'rgba(0,0,0,0.2)';
            certCtx.shadowBlur = 10;
            certCtx.shadowOffsetY = 4;
            certCtx.drawImage(img, 0, 0, cw, ch, x, y, w, h);
            certCtx.shadowColor = 'transparent';
            certCtx.shadowBlur = 0;
            certCtx.shadowOffsetY = 0;
        }
        
        // Mock analysis function for when API is not available
        function mockGemstoneAnalysis() {
            const gemstones = [
                {
                    name: "Diamond", category: "Gemstone", color: "Colorless", cut: "Round Brilliant",
                    carat: "1.25 ct", ratio: "1.00", dims: "6.8 Ã— 6.8 Ã— 4.1 mm", clarity: "VS1",
                    origin: "South Africa", astro: "Associated with Venus. Brings wealth, luxury, and harmony in relationships."
                },
                {
                    name: "Sapphire", category: "Gemstone", color: "Blue", cut: "Oval",
                    carat: "2.55 ct", ratio: "1.45", dims: "9.2 Ã— 6.3 Ã— 4.8 mm", clarity: "VVS2",
                    origin: "Sri Lanka", astro: "Associated with Saturn. Provides discipline, focus, and protection from negative energies."
                },
                {
                    name: "Ruby", category: "Gemstone", color: "Red", cut: "Cushion",
                    carat: "1.85 ct", ratio: "1.12", dims: "7.5 Ã— 6.7 Ã— 5.2 mm", clarity: "SI1",
                    origin: "Myanmar", astro: "Associated with the Sun. Enhances leadership, confidence, and vitality."
                },
                {
                    name: "Emerald", category: "Gemstone", color: "Green", cut: "Emerald Cut",
                    carat: "2.10 ct", ratio: "1.35", dims: "8.9 Ã— 6.6 Ã— 5.0 mm", clarity: "SI2",
                    origin: "Colombia", astro: "Associated with Mercury. Improves communication, intelligence, and business success."
                }
            ];
            
            // Return a random number of gemstones (1 to 3) for the demo
            const count = Math.floor(Math.random() * 3) + 1;
            const selected = [];
            const tempGems = [...gemstones];
            for (let i = 0; i < count; i++) {
                const index = Math.floor(Math.random() * tempGems.length);
                selected.push(tempGems.splice(index, 1)[0]);
            }
            return selected;
        }
        
        async function analyzeAndFillFields(base64Data, originalImg, apiKey) {
            const prompt = `Analyze all the stones, which could be gemstones or minerals, in the image. Identify their properties and provide the details in a JSON array. If the information is not available from the image, make an educated guess or mark as "Not Assessed".
            
            JSON schema for each object in the array:
            - name: The specific type of gemstone or mineral (e.g., Pyrite, Hematite, Diamond, Sapphire).
            - category: 'Gemstone' or 'Mineral'.
            - color: The dominant color of the stone.
            - cut: The cut style of the stone (e.g., Natural, Rough, Round Brilliant, Oval).
            - carat: A realistic estimate of the stone's carat weight. Use a value like "2.55 ct".
            - ratio: The length-to-width ratio of the stone. Use a value like "1.25".
            - dims: Estimated dimensions of the stone in millimeters. Use a format like "8.2 Ã— 6.5 Ã— 4.1 mm".
            - clarity: An estimate of the stone's clarity grade (e.g., Opaque, Translucent, VS, SI, I).
            - origin: A probable origin country/region for this type of stone.
            - astro: The astrological use or association of the stone. Provide a concise, brief description in one to two sentences.`;

            if (!apiKey) {
                showToast('Using demo data (no API key provided)', 'default', 5000);
                await new Promise(resolve => setTimeout(resolve, 1500));
                lastAnalysisData = mockGemstoneAnalysis();
                populateGemData(lastAnalysisData, originalImg);
                return;
            }

            const payload = {
                contents: [{
                    parts: [{ text: prompt }, {
                        inlineData: { mimeType: "image/jpeg", data: base64Data }
                    }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "name": { "type": "STRING" },
                                "category": { "type": "STRING" },
                                "color": { "type": "STRING" },
                                "cut": { "type": "STRING" },
                                "carat": { "type": "STRING" },
                                "ratio": { "type": "STRING" },
                                "dims": { "type": "STRING" },
                                "clarity": { "type": "STRING" },
                                "origin": { "type": "STRING" },
                                "astro": { "type": "STRING" }
                            },
                            required: ["name", "category", "color", "cut", "carat", "ratio", "dims", "clarity", "origin", "astro"]
                        }
                    }
                }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                
                if (!result.candidates || result.candidates.length === 0 || !result.candidates[0].content || !result.candidates[0].content.parts || result.candidates[0].content.parts.length === 0) {
                    throw new Error("Invalid response structure from API.");
                }

                const jsonString = result.candidates[0].content.parts[0].text;
                const gemDataArray = JSON.parse(jsonString);
                
                lastAnalysisData = gemDataArray;
                populateGemData(lastAnalysisData, originalImg);
                showToast('Certificate analysis complete!', 'success');

            } catch (error) {
                console.error("Analysis failed:", error);
                showToast(`Analysis failed: ${error.message}. Using demo data instead.`, 'error');
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                lastAnalysisData = mockGemstoneAnalysis();
                populateGemData(lastAnalysisData, originalImg);
            }
        }
        
        function populateGemData(gemDataArray, originalImg) {
            certContainer.innerHTML = '';
            metricsEl.innerHTML = '';
            
            if (gemDataArray.length === 0) {
                showToast('No stones were detected in the image.', 'error');
                return;
            }

            // Populate analysis metrics for the first stone only, as a summary
            const gemData = gemDataArray[0];
            const m1 = document.createElement('div');
            m1.className = 'metric';
            m1.innerHTML = `<div class='k'>Stone Name</div><div class='v'>${gemData.name || 'Not Assessed'}</div>`;
            const m2 = document.createElement('div');
            m2.className = 'metric';
            m2.innerHTML = `<div class='k'>Color</div><div class='v'>${gemData.color || 'Not Assessed'}</div>`;
            const m3 = document.createElement('div');
            m3.className = 'metric';
            m3.innerHTML = `<div class='k'>Est. Carat</div><div class='v'>${gemData.carat || 'Not Assessed'}</div>`;
            const m4 = document.createElement('div');
            m4.className = 'metric';
            m4.innerHTML = `<div class='k'>Cut Style</div><div class='v'>${gemData.cut || 'Not Assessed'}</div>`;
            metricsEl.appendChild(m1);
            metricsEl.appendChild(m2);
            metricsEl.appendChild(m3);
            metricsEl.appendChild(m4);

            // Generate a single certificate for all stones
            createSingleCertificate(gemDataArray, originalImg);
        }
        
        function createSingleCertificate(gemDataArray, originalImg) {
            const certId = `cert-main`;
            const certNum = String(Date.now()).slice(-6);
            const signer = genRandomIndianName();
            const signatureInitials = getInitialSignature(signer);
            const sealImgSrc = generateSealSVGDataURL();
            
            let stoneRowsHtml = '';

            // Logic to handle single or multiple stones
            if (gemDataArray.length === 1) {
                const gem = gemDataArray[0];
                const caratValue = parseFloat(gem.carat) || 0;
                
                // --- CORRECTED CONVERSION FACTORS BASED ON USER'S EXAMPLE ---
                // User provided: 0.005 Carat = 0.00548... Ratti = 0.001 Gram = 1 Milligram
                // This gives us the following new conversion factors:
                const rattiConversion = (0.0054869684499314125 / 0.005);
                const gramConversion = (0.001 / 0.005);
                const mgConversion = (1 / 0.005);
                
                const ratiDisplay = (caratValue * rattiConversion).toFixed(3);
                const gramDisplay = (caratValue * gramConversion).toFixed(3);
                const mgDisplay = (caratValue * mgConversion).toFixed(3);
                
                stoneRowsHtml = `
                    <div class="stone-entry">
                        <div class="stone-heading">Stone: <input id="fName-0" class="inline" value="${gem.name || 'Not Assessed'}" /></div>
                        <div class="ct-row"><div class="key">Category</div><div class="val"><input id="fCategory-0" class="inline" value="${gem.category || 'Not Assessed'}" /></div></div>
                        <div class="ct-row"><div class="key">Colour</div><div class="val"><input id="fColor-0" class="inline" value="${gem.color || 'Not Assessed'}" /></div></div>
                        <div class="ct-row"><div class="key">Cut</div><div class="val"><input id="fCut-0" class="inline" value="${gem.cut || 'Not Assessed'}" /></div></div>
                        <div class="ct-row"><div class="key">Carat</div><div class="val"><input id="fCarat-0" data-unit="carat" class="inline-input" value="${caratValue}" /></div></div>
                        <div class="ct-row"><div class="key">Ratti</div><div class="val"><input id="fRatti-0" data-unit="ratti" class="inline-input" value="${ratiDisplay}" /></div></div>
                        <div class="ct-row"><div class="key">Gram</div><div class="val"><input id="fGram-0" data-unit="gram" class="inline-input" value="${gramDisplay}" /></div></div>
                        <div class="ct-row"><div class="key">Milligram</div><div class="val"><input id="fMilligram-0" data-unit="milligram" class="inline-input" value="${mgDisplay}" /></div></div>
                        <div class="ct-row"><div class="key">Ratio</div><div class="val"><input id="fRatio-0" class="inline" value="${gem.ratio || 'Not Assessed'}" /></div></div>
                        <div class="ct-row"><div class="key">Dimensions (mm)</div><div class="val"><input id="fDims-0" class="inline" value="${gem.dims || 'Not Assessed'}" /></div></div>
                        <div class="ct-row"><div class="key">Clarity</div><div class="val"><input id="fClarity-0" class="inline" value="${gem.clarity || 'Not Assessed'}" /></div></div>
                        <div class="ct-row"><div class="key">Origin</div><div class="val"><div id="fOrigin-0" class="inline-div" contenteditable="true">${gem.origin || 'Not Assessed'}</div></div></div>
                        <div class="ct-row"><div class="key">Astrological use</div><div class="val"><div id="fAstro-0" class="inline-div" contenteditable="true">${gem.astro || 'Not Assessed'}</div></div></div>
                    </div>
                `;
            } else {
                // Case 2: Multiple Stones - Concatenate values
                const names = gemDataArray.map(g => g.name || 'Not Assessed').join(', ');
                const categories = gemDataArray.map(g => g.category || 'Not Assessed').join(', ');
                const colors = gemDataArray.map(g => g.color || 'Not Assessed').join(', ');
                const carats = gemDataArray.map(g => g.carat || 'Not Assessed').join(', ');
                
                // --- CORRECTED CONVERSION FACTORS BASED ON USER'S EXAMPLE ---
                const rattiConversion = (0.0054869684499314125 / 0.005);
                const gramConversion = (0.001 / 0.005);
                const mgConversion = (1 / 0.005);

                const rattiArray = gemDataArray.map(g => `${(parseFloat(g.carat) * rattiConversion).toFixed(3)}`);
                const rattiDisplay = rattiArray.join(', ');
                const gramArray = gemDataArray.map(g => `${(parseFloat(g.carat) * gramConversion).toFixed(3)}`);
                const gramDisplay = gramArray.join(', ');
                const mgArray = gemDataArray.map(g => `${(parseFloat(g.carat) * mgConversion).toFixed(3)}`);
                const mgDisplay = mgArray.join(', ');
                const ratios = gemDataArray.map(g => g.ratio || 'Not Assessed').join(', ');
                const clarities = gemDataArray.map(g => g.clarity || 'Not Assessed').join(', ');
                const origins = gemDataArray.map(g => g.origin || 'Not Assessed').join(', ');
                // Concise astrological use for multiple stones
                const astroCombined = gemDataArray.map(g => `â€¢ ${g.name}: ${g.astro}`).join(' ');

                // Check for uniformity for Cut and Dimensions
                const allSameCut = new Set(gemDataArray.map(g => g.cut)).size === 1;
                const cutDisplay = allSameCut ? gemDataArray[0].cut : 'Mixed';
                const allSameDims = new Set(gemDataArray.map(g => g.dims)).size === 1;
                const dimsDisplay = allSameDims ? `${gemDataArray[0].dims} (per Stone/Beads)` : 'Mixed';

                stoneRowsHtml = `
                    <div class="stone-entry">
                        <div class="stone-heading">Stones: <div class="inline-div" contenteditable="true">${names}</div></div>
                        <div class="ct-row"><div class="key">Category</div><div class="val"><div class="inline-div" contenteditable="true">${categories}</div></div></div>
                        <div class="ct-row"><div class="key">Colour</div><div class="val"><div class="inline-div" contenteditable="true">${colors}</div></div></div>
                        <div class="ct-row"><div class="key">Cut</div><div class="val"><div class="inline-div" contenteditable="true">${cutDisplay}</div></div></div>
                        <div class="ct-row"><div class="key">Carat</div><div class="val"><div class="inline-div" contenteditable="true">${carats}</div></div></div>
                        <div class="ct-row"><div class="key">Ratti</div><div class="val"><div class="inline-div" contenteditable="true">${rattiDisplay}</div></div></div>
                        <div class="ct-row"><div class="key">Gram</div><div class="val"><div class="inline-div" contenteditable="true">${gramDisplay}</div></div></div>
                        <div class="ct-row"><div class="key">Milligram</div><div class="val"><div class="inline-div" contenteditable="true">${mgDisplay}</div></div></div>
                        <div class="ct-row"><div class="key">Ratio</div><div class="val"><div class="inline-div" contenteditable="true">${ratios}</div></div></div>
                        <div class="ct-row"><div class="key">Dimensions (mm)</div><div class="val"><div class="inline-div" contenteditable="true">${dimsDisplay}</div></div></div>
                        <div class="ct-row"><div class="key">Clarity</div><div class="val"><div class="inline-div" contenteditable="true">${clarities}</div></div></div>
                        <div class="ct-row"><div class="key">Origin</div><div class="val"><div class="inline-div" contenteditable="true">${origins}</div></div></div>
                        <div class="ct-row"><div class="key">Astrological use</div><div class="val"><div class="inline-div" contenteditable="true">${astroCombined}</div></div></div>
                    </div>
                `;
            }

            const certHTML = `
                <div class="cert" id="${certId}">
                    <div class="watermark">GTL</div>
                    <div class="cert-head">
                        <div>
                            <div class="cert-title">GEM TESTING (IDENTIFICATION) LABORATORY</div>
                            <div class="muted small">Certificate issued on behalf of <span id="fIssuedBy-0" class="issued-by-name inline-span" contenteditable="true" placeholder="Enter name"></span>, India</div>
                        </div>
                        <div class="cert-meta">
                            <div class="small">Certificate #</div>
                            <div id="certNo-0">${certNum}</div>
                            <div class="small" style="margin-top:8px">Date</div>
                            <input type="date" id="certDate-0" class="inline-input" style="text-align:right" value="${new Date().toISOString().split('T')[0]}" />
                        </div>
                    </div>

                    <div class="cert-body">
                        <div class="thumb"><canvas id="certCanvas-0" width="300" height="400"></canvas></div>
                        <div class="cert-table">
                            ${stoneRowsHtml}
                        </div>
                    </div>

                    <div class="sig-row">
                        <div class="sig-box" id="signBox-0"><img id="sigImg-0" style="max-width:220px;display:block;margin:0 auto"/><div id="sigName-0" class="muted">${signer}</div></div>
                        <div class="sig-box" id="sealBox-0"><img id="sealImg-0" style="max-width:120px;display:block;margin:0 auto" src="${sealImgSrc}"/><div class="muted">Laboratory Seal</div></div>
                    </div>
                </div>
            `;
            
            certContainer.insertAdjacentHTML('beforeend', certHTML);
            
            const canvas = document.getElementById(`certCanvas-0`);
            renderCertificateImage(canvas, originalImg);
            
            generateInitialSignatureDataURL(signatureInitials).then(data => {
                const sigImgEl = document.getElementById(`sigImg-0`);
                if (sigImgEl) {
                    sigImgEl.src = data;
                }
            });

            // Add event listeners for the new fields for single stones
            if (gemDataArray.length === 1) {
                const caratInput = document.getElementById('fCarat-0');
                const rattiInput = document.getElementById('fRatti-0');
                const gramInput = document.getElementById('fGram-0');
                const mgInput = document.getElementById('fMilligram-0');

                [caratInput, rattiInput, gramInput, mgInput].forEach(input => {
                    input.addEventListener('input', (event) => {
                        updateCalculations(event.target.value, event.target.dataset.unit);
                    });
                });
            }
        }
        
        // --- New Function: Auto-calculate and update weight fields ---
        function updateCalculations(value, unit) {
            let caratValue = parseFloat(value);
            if (isNaN(caratValue)) {
                caratValue = 0;
            }

            // --- CORRECTED CONVERSION FACTORS BASED ON USER'S EXAMPLE ---
            // User provided: 0.005 Carat = 0.0054869684499314125 Ratti = 0.001 Gram = 1 Milligram
            const conversionRattiToCarat = 0.005 / 0.0054869684499314125;
            const conversionGramToCarat = 0.005 / 0.001; // 5
            const conversionMilligramToCarat = 0.005 / 1; // 0.005

            // Define conversion rates to Carat as the base unit
            const conversions = {
                carat: 1,
                ratti: conversionRattiToCarat,
                gram: conversionGramToCarat,
                milligram: conversionMilligramToCarat
            };

            let baseCarat = 0;
            if (caratValue > 0) {
                baseCarat = caratValue * conversions[unit];
            }

            const caratInput = document.getElementById('fCarat-0');
            const rattiInput = document.getElementById('fRatti-0');
            const gramInput = document.getElementById('fGram-0');
            const mgInput = document.getElementById('fMilligram-0');

            if (caratInput && rattiInput && gramInput && mgInput) {
                // Update all fields based on the new baseCarat value
                const rattiConversion = (0.0054869684499314125 / 0.005);
                const gramConversion = (0.001 / 0.005);
                const mgConversion = (1 / 0.005);

                if (unit !== 'carat') {
                    caratInput.value = baseCarat.toFixed(3);
                }
                if (unit !== 'ratti') {
                    rattiInput.value = (baseCarat * rattiConversion).toFixed(3);
                }
                if (unit !== 'gram') {
                    gramInput.value = (baseCarat * gramConversion).toFixed(3);
                }
                if (unit !== 'milligram') {
                    mgInput.value = (baseCarat * mgConversion).toFixed(3);
                }
            }
        }

        // --- Signature and Seal Generation ---
        function genRandomIndianName() {
            const first = ['Aarav', 'Arjun', 'Rohan', 'Vikram', 'Siddharth', 'Karan', 'Aman', 'Vivek', 'Rahul', 'Ravi', 'Manish', 'Deepak', 'Rakesh', 'Raj'];
            const last = ['Sharma', 'Singh', 'Patel', 'Verma', 'Gupta', 'Reddy', 'Nair', 'Joshi', 'Iyer', 'Chopra'];
            return first[Math.floor(Math.random() * first.length)] + ' ' + last[Math.floor(Math.random() * last.length)];
        }
        
        function getInitialSignature(fullName) {
            const parts = fullName.split(' ');
            if (parts.length === 1) return parts[0].charAt(0);
            const firstName = parts[0].charAt(0);
            const lastName = parts[parts.length - 1];
            return firstName + '. ' + lastName;
        }
        
        async function generateInitialSignatureDataURL(signatureText) {
            try {
                await document.fonts.load('48px "Great Vibes"');
            } catch (e) {}
            
            const c = document.createElement('canvas');
            c.width = 320;
            c.height = 100;
            const ctx = c.getContext('2d');
            ctx.clearRect(0, 0, c.width, c.height);
            ctx.fillStyle = 'transparent';
            ctx.fillRect(0, 0, c.width, c.height);
            ctx.fillStyle = '#0f172a';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '42px "Great Vibes", cursive';
            
            ctx.save();
            ctx.translate(c.width / 2, c.height / 2);
            ctx.rotate(-0.1);
            ctx.fillText(signatureText, 0, 0);
            ctx.restore();
            
            return c.toDataURL('image/png');
        }
        
        function generateSealSVGDataURL() {
            const sealColor = 'none';
            const borderColor = '#4b5563';
            const textColor = '#228B22';
            const fontSize = '10';

            const svg = `
                <svg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 100 100'>
                    <defs>
                        <path id="top-text-path" d="M 20 50 A 30 30 0 1 1 80 50"/>
                    </defs>
                    <circle cx="50" cy="50" r="45" stroke="${borderColor}" stroke-width="2" fill="none" />
                    
                    <!-- Top Curved Text with "(I)" -->
                    <text font-size="${fontSize}" font-weight="bold" font-family="Cinzel, serif" fill="${textColor}" text-anchor="middle">
                        <textPath href="#top-text-path" startOffset="50%">GEM TESTING (I)</textPath>
                    </text>
                    
                    <!-- Straight Text at the bottom -->
                    <text x="50" y="80" font-size="${fontSize}" font-weight="bold" font-family="Cinzel, serif" fill="${textColor}" text-anchor="middle">LABORATORY</text>
                    
                    <!-- Stylized Star shape, flipped to be upright -->
                    <g transform="translate(50, 50) rotate(0)">
                        <path d="M0, -22 L 6, -6 L 22, -6 L 10, 3 L 15, 18 L 0, 10 L -15, 18 L -10, 3 L -22, -6 L -6, -6 Z" fill="${textColor}" />
                    </g>
                </svg>`;
            return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }

        // --- PDF and Image Generation ---
        async function checkIssuedByNames() {
            const issuedByFields = document.querySelectorAll('.issued-by-name');
            let allFilled = true;
            issuedByFields.forEach(field => {
                if (!field.textContent.trim()) {
                    field.style.border = '2px solid red';
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    allFilled = false;
                } else {
                    field.style.border = ''; // Reset border if filled
                }
            });
            if (!allFilled) {
                showToast('Please fill in the "Issued By" name for all certificates.', 'error');
            }
            return allFilled;
        }

        downloadBtn.addEventListener('click', async () => {
            if (!await checkIssuedByNames()) return;

            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Preparing...';
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
                const certificates = document.querySelectorAll('.cert');

                for (let i = 0; i < certificates.length; i++) {
                    const node = certificates[i];
                    const canvas = await html2canvas(node, { scale: 3, backgroundColor: '#ffffff' });
                    const img = canvas.toDataURL('image/png');

                    if (i > 0) {
                        pdf.addPage();
                    }

                    const margin = 36;
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const scaleFactor = Math.min((pdfWidth - margin * 2) / canvasWidth, (pdfHeight - margin * 2) / canvasHeight);
                    const w = canvasWidth * scaleFactor;
                    const h = canvasHeight * scaleFactor;
                    const x = (pdfWidth - w) / 2;
                    const y = (pdfHeight - h) / 2;

                    pdf.addImage(img, 'PNG', x, y, w, h);
                }

                pdf.save('GTL-Certificates.pdf');
                showToast('PDF downloaded successfully', 'success');
            } catch (e) {
                showToast('PDF error: ' + (e.message || e), 'error');
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'Download PDF';
            }
        });

        downloadImageBtn.addEventListener('click', async () => {
            if (!await checkIssuedByNames()) return;

            downloadImageBtn.disabled = true;
            downloadImageBtn.textContent = 'Capturing...';
            downloadImageBtn.classList.add('btn-loading');

            try {
                const certificates = document.querySelectorAll('.cert');
                if (certificates.length === 1) {
                    const canvas = await html2canvas(certificates[0], { scale: 3, backgroundColor: '#ffffff' });
                    const imageURL = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = imageURL;
                    link.download = `GTL-CERT.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('Image downloaded successfully', 'success');
                } else if (certificates.length > 1) {
                    showToast('To download as an image, please download each certificate individually.', 'error');
                } else {
                    showToast('No certificates to download.', 'error');
                }
            } catch (e) {
                showToast('Image download error: ' + (e.message || e), 'error');
            } finally {
                downloadImageBtn.disabled = false;
                downloadImageBtn.textContent = 'Download Image';
                downloadImageBtn.classList.remove('btn-loading');
            }
        });


        // --- Load saved data on startup ---
        (function loadSaved() {
            const raw = localStorage.getItem('srn:lastCertSimple');
            if (!raw) return;
            try {
                const o = JSON.parse(raw);
                if (o.image) {
                    originalImage = new Image();
                    originalImage.onload = () => {
                        enableControls(true);
                    };
                    originalImage.src = o.image;
                    uploadedImagePreview.src = o.image;
                    imagePreviewSection.style.display = 'block';
                }
                if (o.analysisData && Array.isArray(o.analysisData)) {
                    lastAnalysisData = o.analysisData;
                    populateGemData(lastAnalysisData, originalImage);
                }
            } catch (e) {
                console.error("Failed to load saved data:", e);
                showToast('Error loading saved data', 'error');
            }
        })();
    </script>
</body>
</html>